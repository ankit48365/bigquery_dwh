name: DBT CICD

on:
  push:
    branches:
      - 7-integrate-piperider  
  pull_request:
    branches:
      - main  

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      # - name: Debug Environment Variables
      #   run: env

      - name: Debug GitHub Actions Workspace
        run: |
          echo "RUNNER_WORKSPACE is at: $RUNNER_WORKSPACE"
          ls -R $RUNNER_WORKSPACE

      - name: Install SQLFluff
        run: pip install sqlfluff sqlfluff-templater-dbt

      - name: Set dbt paths
        run: |
          export DBT_PROFILES_DIR=$RUNNER_WORKSPACE/proj_dbt
          export DBT_PROJECT_DIR=$RUNNER_WORKSPACE/proj_dbt/dbt_pizza
        
      # - name: Verify dbt files
      #   run: ls -R /home/runner/work/bigquery_dwh/proj_dbt/dbt_pizza

      - name: Run SQLFluff linting
        run: sqlfluff lint ./proj_dbt/dbt_pizza/models/

  # recce-summary:
  #   runs-on: ubuntu-latest

  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v3

  #     - name: Set up Python
  #       uses: actions/setup-python@v4
  #       with:
  #         python-version: "3.12"

  #     - name: Install dependencies
  #       run: |
  #         pip install --upgrade pip
  #         pip install packaging dbt-core dbt-bigquery recce agate

  #     - name: Generate Recce summary
  #       run: recce summary recce-state.json
  #       working-directory: ./proj_dbt/dbt_pizza/

#####   above this runs, but was disabled for testing





      # - name: Run dbt compilation (required for Recce)
      #   run: dbt compile
      #   working-directory: ./proj_dbt/dbt_pizza/
      
      # - name: Run Recce validation
      #   run: recce run --output recce-state.json
      #   working-directory: ./proj_dbt/dbt_pizza/



      #  run: recce run --output recce-state.json --profiles-dir ./proj_dbt
      # pip install packaging dbt-core dbt-bigquery recce agate
      #   